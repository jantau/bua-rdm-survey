---
output: html_document
editor_options: 
  chunk_output_type: console
---
# Förderstruktur {#foerderung}

```{r, include=FALSE}
source("source.R")
```


## Form von Förderstruktur

Von den Umfrageteilnehmenden gaben 29,4% (136 von 463) an, dass ihre Arbeit durch nationale Verbundprojekte (Exzellenzcluster, Sonderforschungsbereich, Transregio, Verbundprojekt des Bundes oder DFG) gefördert würde. 7,1% (33 von 463) werden durch europäische Förderstrukturen (European Research Council oder EU-Verbundprojekt) gefördert. 6,9% (32 von 463) der Umfrageteilnehmenden werden sowohl durch nationale als auch europäische Förderstrukturen gefördert.


```{r support, fig.cap="Förderstruktur"}
drittm <- data %>%
  filter(str_detect(question_id, "^ORG_[1-9]")) %>%
  filter(!value_decoded %in% c("n. geantwortet", "n. gestellt")) %>%
  drop_na(value_decoded) %>%
  group_by(data_id) %>%
  # Change DFG input to nationale Förderung and remove ORG_7
  mutate(question_id = case_when(
    any(str_detect(question_id, "^ORG_[89]")) &
      any(str_detect(value, regex("DFG", ignore_case = TRUE))) ~ "ORG_1",
    str_detect(question_id, "^ORG_[89]") &
      str_detect(value, regex("DFG", ignore_case = TRUE), negate = TRUE) ~ "ORG_7",
    TRUE ~ question_id
  )) %>%
  # Create new column
  mutate(
    value_grouped = case_when(
      any(str_detect(question_id, "^ORG_[1235]$")) &
        any(str_detect(question_id, "^ORG_[46]$")) ~ "nationale und europ. Förderung",
      str_detect(question_id, "^ORG_[1235]$") ~ "nationale Verbundprojekte",
      str_detect(question_id, "^ORG_[46]") ~ "europäische Förderung",
      str_detect(question_id, "^ORG_[7]") ~ "andere oder keine Förderstruktur",
      TRUE ~ as.character(NA)
    )
  ) %>%
  select(data_id, question_id, value_grouped) %>%
  ungroup() %>%
  drop_na(value_grouped) %>%
  distinct(data_id, .keep_all = TRUE) %>%
  select(-question_id)

drittm_count <- drittm %>%
  add_count(name = "nn") %>%
  count(value_grouped, nn) %>%
  mutate(value_grouped = fct_reorder(value_grouped, n, .desc = TRUE)) %>%
  arrange(-n)

drittm_count %>%
  plot_ly(
    labels = ~value_grouped,
    values = ~n,
    textposition = "auto",
    texttemplate = ~ str_glue("{value_grouped}
                            {round((n/nn)*100, 1)}% ({n})"),
    insidetextorientation = "horizontal",
    automargin = TRUE,
    showlegend = FALSE,
    direction = "clockwise",
    pull = c(0.05, 0, 0, 0),
    marker = list(
      colors = col_cat[c(1:3, 5)],
      line = list(col = "#FFFFFF", width = 1)
    ),
    type = "pie"
  ) %>%
  layout_title(text = "Welcher Organisationseinheit\nbzw. welcher Form von Förderstruktur gehören Sie an?", margin = list(t = 100)) %>%
  layout_caption(text = ~ glue::glue("BUA FDM-Umfrage 2021/22, n={nn}",
    nn = max(nn)
  )) %>%
  layout_mode_bar() %>%
  layout(uniformtext = list(minsize = 11, mode = "hide"))
```

## Datenmanagementpläne

```{r förderung-1, fig.cap="Förderstruktur"}
# DMP1

dmp <- data %>%
  filter(str_detect(question_id, "^DMP1$")) %>%
  filter(!value_decoded %in% c("n. geantwortet", "n. gestellt")) %>%
  drop_na(value_decoded) %>%
  select(data_id, value_decoded)

dritt_dmp <-
  drittm %>%
  full_join(dmp, by = "data_id") %>%
  drop_na() %>%
  filter(value_decoded != "DMP falsch verstanden") %>%
  count(value_grouped, value_decoded) %>%
  group_by(value_decoded) %>%
  group_modify(~ .x %>% adorn_totals("row", name = "Alle")) %>%
  group_by(value_grouped) %>%
  mutate(
    perc = n / sum(n),
    n_group = sum(n)
  ) %>%
  ungroup() %>%
  mutate(nn = sum(n) / 2) %>%
  #   add_count(name = "nn") %>%

  mutate(value_grouped = paste0(value_grouped, "\nn=", n_group)) %>%
  group_by(value_grouped) %>%
  mutate(rank = max(perc[value_decoded == "Ja, mehrmals"])) %>%
  ungroup() %>%
  mutate(value_grouped = fct_reorder(value_grouped, rank, .desc = TRUE)) %>%
  mutate(value_grouped = relevel(value_grouped, 3)) %>%
  # mutate(value_grouped = fct_reorder(value_grouped, n, first)) %>%

  mutate(value_decoded = factor(value_decoded, levels = c("Ja, mehrmals", "Ja, einmal", "Nein", "Ich weiß nicht")))

dritt_dmp %>%
  plot_ly(
    x = ~perc,
    y = ~value_grouped,
    color = ~value_decoded,
    colors = col_lik[c(5, 4, 1, 3)],
    text = ~ paste0(round(perc * 100, 0), "% (", n, ")"),
    textposition = "inside",
    insidetextanchor = "middle",
    textangle = 0,
    textfont = list(color = "white", size = 11),
    type = "bar"
  ) %>%
  layout_bar_flip("stack",
    autorange = "reversed",
    legend_title = "Haben Sie schon einmal einen DMP erstellt?"
  ) %>%
  layout_title(text = "Haben Sie schon einmal einen DMP erstellt?\nnach Organisationseinheit/Förderstruktur") %>%
  layout_caption() %>%
  layout_mode_bar() %>%
  layout(
    shapes = list(
      type = "line",
      x0 = -0.05,
      x1 = 1,
      xref = "paper",
      y0 = 0.5,
      y1 = 0.5,
      line = list(color = "black", dash = "dot")
    )
  )
```

## Unterstützung zu FDM-Themen

Forschende in Verbundprojekten (europäisch, national oder beides) nehmen mehr Support in Anspruch (5.0.2.1) (in Anspruch genommen v. nicht in Anspruch genommen, gefiltert nach EU-Förderung, nationale Verbundprojekte, beides, oder keine/andere Förderung) 

```{r förderung-2, fig.cap="Förderstruktur"}
sup <- data %>%
  filter(str_detect(question_id, "^SUP1$")) %>%
  filter(!value_decoded %in% c("n. geantwortet", "n. gestellt")) %>%
  drop_na(value_decoded) %>%
  select(data_id, value_decoded)

dritt_sup <-
  drittm %>%
  full_join(sup, by = "data_id") %>%
  drop_na() %>%
  count(value_grouped, value_decoded) %>%
  group_by(value_decoded) %>%
  group_modify(~ .x %>% adorn_totals("row", name = "Alle")) %>%
  group_by(value_grouped) %>%
  mutate(
    perc = n / sum(n),
    n_group = sum(n)
  ) %>%
  ungroup() %>%
  mutate(nn = sum(n) / 2) %>%
  mutate(value_grouped = paste0(value_grouped, "\nn=", n_group)) %>%
  group_by(value_grouped) %>%
  mutate(rank = max(perc[value_decoded == "Ja"])) %>%
  ungroup() %>%
  mutate(value_grouped = fct_reorder(value_grouped, rank, .desc = TRUE)) %>%
  mutate(value_grouped = relevel(value_grouped, 4)) %>%
  # mutate(value_grouped = fct_reorder(value_grouped, n, first)) %>%
  mutate(value_decoded = factor(value_decoded, levels = c("Ja", "Nein", "Bin mir nicht sicher")))

dritt_sup %>%
  plot_ly(
    x = ~perc,
    y = ~value_grouped,
    color = ~value_decoded,
    colors = col_lik[c(5, 1, 3)],
    text = ~ paste0(round(perc * 100, 0), "% (", n, ")"),
    textposition = "inside",
    insidetextanchor = "middle",
    textangle = 0,
    textfont = list(color = "white", size = 11),
    type = "bar"
  ) %>%
  layout_bar_flip(
    barmode = "stack",
    autorange = "reversed",
    legend_title = "Haben Sie fachliche Unterstützung zu FDM-Themen in Anspruch genommen?"
  ) %>%
  layout_title(text = "Haben Sie fachliche Unterstützung zu FDM-Themen in Anspruch genommen?\nnach Organisationseinheit/Förderstruktur") %>%
  layout_caption() %>%
  layout_mode_bar() %>%
  layout(
    shapes = list(
      type = "line",
      x0 = -0.05,
      x1 = 1,
      xref = "paper",
      y0 = 0.5,
      y1 = 0.5,
      line = list(color = "black", dash = "dot")
    )
  )
```


## Kontakte zu FDM

```{r förderung-3, fig.cap="Förderstruktur"}
con <- data %>%
  filter(str_detect(question_id, "^CON_([1-9]$|11)")) %>%
  select(data_id, value) %>%
  # Change freetext answers to 1
  filter(value != "-999") %>%
  mutate(value = case_when(
    !value %in% c("0", "1") ~ "1",
    TRUE ~ value
  )) %>%
  group_by(data_id) %>%
  summarise(sum_con = sum(as.numeric(value))) %>%
  # Group contacts
  mutate(
    sum_con = case_when(
      sum_con == 0 ~ "keine",
      sum_con == 1 ~ "1",
      sum_con == 2 ~ "2",
      sum_con == 3 ~ "3",
      sum_con == 4 ~ "4",
      sum_con >= 5 ~ "5 oder mehr"
    )
  )

dritt_con <-
  drittm %>%
  full_join(con, by = "data_id") %>%
  drop_na() %>%
  count(value_grouped, sum_con) %>%
  group_by(sum_con) %>%
  group_modify(~ .x %>% adorn_totals("row", name = "Alle")) %>%
  group_by(value_grouped) %>%
  mutate(
    perc = n / sum(n),
    n_group = sum(n)
  ) %>%
  ungroup() %>%
  mutate(nn = sum(n) / 2) %>%
  mutate(value_grouped = paste0(value_grouped, "\nn=", n_group)) %>%
  group_by(value_grouped) %>%
  mutate(rank = max(perc[sum_con == "5 oder mehr"])) %>%
  ungroup() %>%
  mutate(value_grouped = fct_reorder(value_grouped, rank, .desc = TRUE)) %>%
  mutate(value_grouped = relevel(value_grouped, 3)) %>%
  mutate(sum_con = factor(sum_con, levels = c(
    "5 oder mehr",
    "4",
    "3",
    "2",
    "1",
    "keine"
  )))


dritt_con %>%
  plot_ly(
    x = ~perc,
    y = ~value_grouped,
    color = ~sum_con,
    colors = col_lik[c(5, 4, 2, 1)],
    text = ~ paste0(round(perc * 100, 0), "% (", n, ")"),
    textposition = "inside",
    insidetextanchor = "middle",
    textangle = 0,
    textfont = list(color = "white", size = 11),
    type = "bar"
  ) %>%
  layout_bar_flip(
    barmode = "stack",
    autorange = "reversed"
  ) %>%
  layout_title(text = "Anzahl Kontakte zum Thema Forschungsdatenmanagement:\nnach Organisationseinheit/Förderstruktur") %>%
  layout(
    legend = list(orientation = "h"),
    shapes = list(
      type = "line",
      x0 = -0.05,
      x1 = 1,
      xref = "paper",
      y0 = 0.5,
      y1 = 0.5,
      line = list(color = "black", dash = "dot")
    )
  ) %>%
  layout_caption() %>%
  layout_mode_bar()
```
